import logging
import google.generativeai as genai
import time  # Added for retries
import random  # Added for jitter in retries
import asyncio  # Added for async sleep

logger = logging.getLogger(__name__)

# Define supported modes
SUPPORTED_MODES = {
    "brief": "ÐšÑ€Ð°Ñ‚ÐºÐ¾",
    "detailed": "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾",
    "bullet": "Ð¢ÐµÐ·Ð¸ÑÐ½Ð¾",
    "combined": "ÐšÐ¾Ð¼Ð±Ð¾",
    "transcript": "ÐšÐ°Ðº ÐµÑÑ‚ÑŒ",
    "pasha": "ÐŸÐ°ÑˆÐ° Ð¢ÐµÑ…Ð½Ð¸Ðº"
}
DEFAULT_MODE = "brief"

# Max retries for transient errors
MAX_RETRIES = 3

async def process_audio_with_gemini(audio_file_path: str, mode: str) -> tuple[str | None, str | None]:
    """Processes audio using Gemini: transcription + requested mode.

    Args:
        audio_file_path: Path to the audio file.
        mode: The desired processing mode (e.g., 'brief', 'detailed').

    Returns:
        A tuple containing (summary_text, transcript_text). 
        summary_text will be None if only transcript is requested.
        transcript_text will be None if processing fails.
        Returns (None, None) on error.
    """
    logger.info(f"Processing audio file {audio_file_path} with mode '{mode}'")
    
    if mode not in SUPPORTED_MODES:
        logger.error(f"Unsupported mode requested: {mode}")
        return None, None

    # Retry counter and uploaded file reference for cleanup
    retry_count = 0
    audio_file = None
    
    try:
        while retry_count <= MAX_RETRIES:
            try:
                # --- Upload and Process File ---
                # Only upload on first try or if previous attempt failed before upload completed
                if audio_file is None:
                    logger.debug("Uploading audio file to Gemini...")
                    audio_file = genai.upload_file(
                        path=audio_file_path, 
                        mime_type="audio/ogg"  # Specify MIME type for Telegram voice messages
                    )
                    logger.info(f"Audio file uploaded successfully: {audio_file.name} ({audio_file.uri})")
                
                # --- Ensure file is processed before proceeding --- 
                while audio_file.state.name == "PROCESSING":
                    logger.debug("File still processing...")
                    # Add small delay to avoid busy-waiting
                    await asyncio.sleep(1)
                    audio_file = genai.get_file(audio_file.name)

                if audio_file.state.name == "FAILED":
                    logger.error(f"Gemini file processing failed for {audio_file.name}")
                    # Cleanup and prepare for retry
                    try:
                        genai.delete_file(audio_file.name)
                        audio_file = None
                    except Exception:
                        pass  # Ignore deletion errors
                    
                    # Raise to trigger retry
                    raise ValueError("File processing failed on Gemini server")
                
                logger.debug("Audio file ready for use.")

                # --- Select Model ---
                # Using Gemini 1.5 Flash for fast processing
                model = genai.GenerativeModel(model_name="models/gemini-2.0-flash")

                # --- Define Improved Prompts ---
                # Transcript first - this is our base for everything else
                transcription_prompt = """
                Transcribe the following audio file accurately in Russian. 
                Preserve the speaker's exact words, but you may add punctuation and paragraphs for readability.
                """
                
                # Enhanced prompts for better summaries
                brief_summary_prompt = """
                Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÑƒÑŽ, Ð½Ð¾ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½ÑƒÑŽ ÑÐ²Ð¾Ð´ÐºÑƒ (3-5 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹) Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.
                Ð¡Ð¾ÑÑ€ÐµÐ´Ð¾Ñ‚Ð¾Ñ‡ÑŒÑÑ Ð½Ð° ÐºÐ»ÑŽÑ‡ÐµÐ²Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸, Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð¸Ð´ÐµÑÑ… Ð¸ Ð²Ð°Ð¶Ð½Ñ‹Ñ… Ð´ÐµÑ‚Ð°Ð»ÑÑ….
                Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÑÐ½Ñ‹Ð¹, Ð»Ð°ÐºÐ¾Ð½Ð¸Ñ‡Ð½Ñ‹Ð¹ ÑÐ·Ñ‹Ðº Ð¸ Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ.
                
                ÐžÐ§Ð•ÐÐ¬ Ð’ÐÐ–ÐÐž: 
                - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð’Ð¡Ð• Ð¸Ð¼ÐµÐ½Ð° Ð»ÑŽÐ´ÐµÐ¹ Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹, ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
                - Ð’ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ (ÐœÐ¸ÑˆÐ°, Ð¡Ð°ÑˆÐ°, ÐšÐ°Ñ‚Ñ Ð¸ Ñ‚.Ð´.)
                - ÐÐ• Ð·Ð°Ð¼ÐµÐ½ÑÐ¹ Ð¸Ð¼ÐµÐ½Ð° Ð½Ð° Ð¾Ð±Ð¾Ð±Ñ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ñ‚Ð¸Ð¿Ð° "Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰Ð¸Ð¹", "ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº" Ð¸Ð»Ð¸ "ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº"
                - Ð•ÑÐ»Ð¸ ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸ ÑÑ‚Ð¾ Ð¸Ð¼Ñ
                
                Ð’ÐÐ–ÐÐž: Telegram Ð¸Ð¼ÐµÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Markdown. Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð° (Ð½Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ñ… Ð² Ð·Ð²ÐµÐ·Ð´Ð¾Ñ‡ÐºÐ¸)
                - ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð·Ð½Ð°ÐºÐ¸ # Ð´Ð»Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð², Ð¾Ð½Ð¸ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð² Telegram
                - Ð•ÑÐ»Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð» Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾ Ð½Ð° 100%, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑƒÐ¶ÑÐºÐ¾Ð¹ Ñ€Ð¾Ð´ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ, 
                  Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¶ÐµÐ½ÑÐºÐ¸Ðµ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð² ÑÐºÐ¾Ð±ÐºÐ°Ñ…: Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð»(Ð°)", "ÑÐºÐ°Ð·Ð°Ð»(Ð°)"
                
                ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:
                
                ðŸ“ ÐšÐ ÐÐ¢ÐšÐ˜Ð™ Ð¡ÐÐœÐœÐÐ Ð˜ Ð’ÐžÐ™Ð¡Ð:
                
                ðŸ—£ï¸ ÐÐ½Ð´Ñ€ÐµÐ¹ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ ÐœÐ¸ÑˆÑƒ, Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð»Ð¸ Ð¾Ð½ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð½Ð¾Ñ‡ÑŒÑŽ Ð´Ð»Ñ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°. ÐÐ½Ð´Ñ€ÐµÐ¹ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚ÑÑ, Ñ…Ð¾Ñ‡ÐµÑ‚ Ð»Ð¸ ÐœÐ¸ÑˆÐ° Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ÑÑŒ Ñ Ð½Ð¸Ð¼ Ð¿Ð¾ Ð·Ð²Ð¾Ð½ÐºÑƒ Ð² 10:30 Ð¿Ð¾ ÑÐ´ÐµÐ»Ð°Ð½Ð½Ð¾Ð¼Ñƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ ÑÑ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ð»Ð¸, Ð¸Ð»Ð¸ ÐœÐ¸ÑˆÐ° Ñ…Ð¾Ñ‡ÐµÑ‚, Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ² Ð²ÐµÑ€ÑÐ¸ÑŽ, Ð´Ð°Ñ‚ÑŒ ÐµÐ¼Ñƒ Ð¿Ñ€Ð°Ð²ÐºÐ¸. Ð“Ð¾Ð²Ð¾Ñ€ÑÑ‰Ð¸Ð¹ Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð»(Ð°), Ñ‡Ñ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð´Ð¾ ÐºÐ¾Ð½Ñ†Ð° Ð½ÐµÐ´ÐµÐ»Ð¸.
                """
                
                detailed_summary_prompt = """
                Ð¡Ð¾Ð·Ð´Ð°Ð¹ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÑƒÑŽ, Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ ÑÐ²Ð¾Ð´ÐºÑƒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.
                Ð¢Ð²Ð¾Ñ ÑÐ²Ð¾Ð´ÐºÐ° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‹ Ð¸ Ð´ÐµÑ‚Ð°Ð»Ð¸.
                
                ÐžÐ§Ð•ÐÐ¬ Ð’ÐÐ–ÐÐž: 
                - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð’Ð¡Ð• Ð¸Ð¼ÐµÐ½Ð° Ð»ÑŽÐ´ÐµÐ¹ Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹, ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
                - Ð’ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ (ÐœÐ¸ÑˆÐ°, Ð¡Ð°ÑˆÐ°, ÐšÐ°Ñ‚Ñ Ð¸ Ñ‚.Ð´.)
                - ÐÐ• Ð·Ð°Ð¼ÐµÐ½ÑÐ¹ Ð¸Ð¼ÐµÐ½Ð° Ð½Ð° Ð¾Ð±Ð¾Ð±Ñ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ñ‚Ð¸Ð¿Ð° "Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰Ð¸Ð¹", "ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº" Ð¸Ð»Ð¸ "ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº"
                - Ð•ÑÐ»Ð¸ ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸ ÑÑ‚Ð¾ Ð¸Ð¼Ñ
                
                Ð’ÐÐ–ÐÐž: Telegram Ð¸Ð¼ÐµÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Markdown. Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð° (Ð½Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ñ… Ð² Ð·Ð²ÐµÐ·Ð´Ð¾Ñ‡ÐºÐ¸)
                - ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð·Ð½Ð°ÐºÐ¸ # Ð´Ð»Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð², Ð¾Ð½Ð¸ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð² Telegram
                - Ð•ÑÐ»Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð» Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾ Ð½Ð° 100%, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑƒÐ¶ÑÐºÐ¾Ð¹ Ñ€Ð¾Ð´ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ, 
                  Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¶ÐµÐ½ÑÐºÐ¸Ðµ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð² ÑÐºÐ¾Ð±ÐºÐ°Ñ…: Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð»(Ð°)", "ÑÐºÐ°Ð·Ð°Ð»(Ð°)"
                
                ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:
                
                ðŸ“‹ ÐŸÐžÐ”Ð ÐžÐ‘ÐÐ«Ð™ Ð¡ÐÐœÐœÐÐ Ð˜ Ð’ÐžÐ™Ð¡Ð:
                
                ðŸ“Œ ÐžÐ‘Ð—ÐžÐ :
                ÐœÐ¸Ñ…Ð°Ð¸Ð» Ð¸ Ð•Ð»ÐµÐ½Ð° Ð¾Ð±ÑÑƒÐ´Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° "ÐÐ»ÑŒÑ„Ð°" Ð¸ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ð»Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ð° Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ.
                
                ðŸ”‘ ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐœÐžÐœÐ•ÐÐ¢Ð«:
                [Ð—Ð´ÐµÑÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð¾Ð², Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð²ÑÐµÑ… Ð¸Ð¼ÐµÐ½]
                
                ðŸ“Š Ð”Ð•Ð¢ÐÐ›Ð˜:
                - ÐœÐ¸Ñ…Ð°Ð¸Ð» ÑÐ¾Ð¾Ð±Ñ‰Ð¸Ð» Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑÑ‚Ð°Ð¿Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
                - Ð•Ð»ÐµÐ½Ð° Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ð»Ð° Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡ÑŒ ÐÐ½Ñ‚Ð¾Ð½Ð° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
                - ÐžÐ±ÑÑƒÐ´Ð¸Ð»Ð¸ Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¸ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ð»Ð¸ Ñ†ÐµÐ»ÑŒ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ðº Ð¿ÑÑ‚Ð½Ð¸Ñ†Ðµ
                
                âœ… Ð˜Ð¢ÐžÐ“Ð˜:
                [ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð¸Ð»Ð¸ Ð·Ð°ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ, ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ð¾]
                """
                
                bullet_points_prompt = """
                ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐ¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸ÑŽ Ð² Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð°Ñ€ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ñ‚ÐµÐ·Ð¸ÑÐ¾Ð² Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.
                
                ÐžÐ§Ð•ÐÐ¬ Ð’ÐÐ–ÐÐž: 
                - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð’Ð¡Ð• Ð¸Ð¼ÐµÐ½Ð° Ð»ÑŽÐ´ÐµÐ¹ Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹, ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
                - Ð’ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ (ÐœÐ¸ÑˆÐ°, Ð¡Ð°ÑˆÐ°, ÐšÐ°Ñ‚Ñ Ð¸ Ñ‚.Ð´.)
                - ÐÐ• Ð·Ð°Ð¼ÐµÐ½ÑÐ¹ Ð¸Ð¼ÐµÐ½Ð° Ð½Ð° Ð¾Ð±Ð¾Ð±Ñ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ñ‚Ð¸Ð¿Ð° "Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰Ð¸Ð¹", "ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº" Ð¸Ð»Ð¸ "ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº"
                - Ð•ÑÐ»Ð¸ ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸ ÑÑ‚Ð¾ Ð¸Ð¼Ñ
                
                Ð’ÐÐ–ÐÐž: Telegram Ð¸Ð¼ÐµÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Markdown. Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð° (Ð½Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ñ… Ð² Ð·Ð²ÐµÐ·Ð´Ð¾Ñ‡ÐºÐ¸)
                - ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð·Ð½Ð°ÐºÐ¸ # Ð´Ð»Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð², Ð¾Ð½Ð¸ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð² Telegram
                - Ð•ÑÐ»Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð» Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾ Ð½Ð° 100%, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑƒÐ¶ÑÐºÐ¾Ð¹ Ñ€Ð¾Ð´ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ, 
                  Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¶ÐµÐ½ÑÐºÐ¸Ðµ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð² ÑÐºÐ¾Ð±ÐºÐ°Ñ…: Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð»(Ð°)", "ÑÐºÐ°Ð·Ð°Ð»(Ð°)"
                
                ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:
                
                ðŸ“‹ Ð¢Ð•Ð—Ð˜Ð¡ÐÐ«Ð™ Ð¡ÐÐœÐœÐÐ Ð˜ Ð’ÐžÐ™Ð¡Ð:
                
                ðŸ“Œ ÐžÐ¡ÐÐžÐ’ÐÐÐ¯ Ð¢Ð•ÐœÐ:
                ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° X Ð¼ÐµÐ¶Ð´Ñƒ ÐÐ»ÐµÐºÑÐµÐµÐ¼ Ð¸ ÐœÐ°Ñ€Ð¸ÐµÐ¹, Ð²ÐºÐ»ÑŽÑ‡Ð°ÑŽÑ‰ÐµÐµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ ÑÑ€Ð¾ÐºÐ¾Ð² Ð¸ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡.
                
                ðŸ”‘ ÐšÐ›Ð®Ð§Ð•Ð’ÐžÐ•:
                - ÐÐ»ÐµÐºÑÐµÐ¹ ÑÐ¿Ñ€Ð¾ÑÐ¸Ð» ÐœÐ°Ñ€Ð¸ÑŽ Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ð·Ð°Ð´Ð°Ñ‡
                - ÐœÐ°Ñ€Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰Ð¸Ð»Ð° Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸ Ð´Ð¸Ð·Ð°Ð¹Ð½-Ð¼Ð°ÐºÐµÑ‚Ð¾Ð²
                - ÐÐ»ÐµÐºÑÐµÐ¹ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ð» Ð½Ð°Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÑŒ Ð²ÑÑ‚Ñ€ÐµÑ‡Ñƒ Ñ Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸ÐµÐ¼ Ð´Ð»Ñ Ð¾Ð±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸
                - ÐžÐ±ÑÑƒÐ´Ð¸Ð»Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¡ÐµÑ€Ð³ÐµÑ Ð´Ð»Ñ backend-Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
                
                ðŸ“Ž Ð”ÐžÐŸÐžÐ›ÐÐ˜Ð¢Ð•Ð›Ð¬ÐÐžÐ•:
                - ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ñ‚ÑŒ Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ñ Ð˜Ñ€Ð¸Ð½Ð¾Ð¹ Ð¸Ð· Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ð´ÐµÐ»Ð°
                
                Ð£Ð±ÐµÐ´Ð¸ÑÑŒ, Ñ‡Ñ‚Ð¾ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð²ÑÐµ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñ‹ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.
                Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ, Ñ‡ÐµÑ‚ÐºÐ¸Ðµ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð°.
                """
                
                combined_summary_prompt = """
                Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ ÑÐ²Ð¾Ð´ÐºÑƒ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.
                
                ÐžÐ§Ð•ÐÐ¬ Ð’ÐÐ–ÐÐž: 
                - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð’Ð¡Ð• Ð¸Ð¼ÐµÐ½Ð° Ð»ÑŽÐ´ÐµÐ¹ Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹, ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
                - Ð’ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ (ÐœÐ¸ÑˆÐ°, Ð¡Ð°ÑˆÐ°, ÐšÐ°Ñ‚Ñ Ð¸ Ñ‚.Ð´.)
                - ÐÐ• Ð·Ð°Ð¼ÐµÐ½ÑÐ¹ Ð¸Ð¼ÐµÐ½Ð° Ð½Ð° Ð¾Ð±Ð¾Ð±Ñ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ñ‚Ð¸Ð¿Ð° "Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰Ð¸Ð¹", "ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº" Ð¸Ð»Ð¸ "ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸Ðº"
                - Ð•ÑÐ»Ð¸ ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ðº ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸ ÑÑ‚Ð¾ Ð¸Ð¼Ñ
                
                Ð’ÐÐ–ÐÐž: Telegram Ð¸Ð¼ÐµÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ Markdown. Ð¡Ð¾Ð±Ð»ÑŽÐ´Ð°Ð¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð° (Ð½Ðµ Ð·Ð°ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ñ… Ð² Ð·Ð²ÐµÐ·Ð´Ð¾Ñ‡ÐºÐ¸)
                - ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð·Ð½Ð°ÐºÐ¸ # Ð´Ð»Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð², Ð¾Ð½Ð¸ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ð² Telegram
                - Ð•ÑÐ»Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð» Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾ Ð½Ð° 100%, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑƒÐ¶ÑÐºÐ¾Ð¹ Ñ€Ð¾Ð´ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ, 
                  Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¶ÐµÐ½ÑÐºÐ¸Ðµ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð² ÑÐºÐ¾Ð±ÐºÐ°Ñ…: Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð»(Ð°)", "ÑÐºÐ°Ð·Ð°Ð»(Ð°)"
                - ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ match tone-of-voice Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾

                ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:
                
                ðŸ“‹ Ð¡ÐÐœÐœÐÐ Ð˜ Ð’ÐžÐ™Ð¡Ð:
                Ð•Ð»ÐµÐ½Ð° Ñ€Ð°ÑÑÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ðµ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼ Ð¸Ð· ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ "X-Tech", Ð³Ð´Ðµ Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ð»Ð¸ÑÑŒ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ðº Ð½Ð¾Ð²Ð¾Ð¼Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ.
                
                ðŸ”‘ ÐšÐ›Ð®Ð§Ð•Ð’ÐžÐ•:
                - Ð•Ð»ÐµÐ½Ð° Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð»Ð°ÑÑŒ Ñ Ð”ÐµÐ½Ð¸ÑÐ¾Ð¼ Ð¸Ð· X-Tech ÑƒÑ‚Ñ€Ð¾Ð¼
                - Ð”ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ð» ÑƒÑÐºÐ¾Ñ€Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿Ð°
                - ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ ÐžÐ»ÐµÐ³Ð¾Ð¼ Ð´Ð»Ñ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ñ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                - ÐÐ°Ñ‚Ð°ÑˆÐ° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð´Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð°
                - ÐÐ½Ð´Ñ€ÐµÐ¹ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð·Ð° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸
                
                ðŸ“Š ÐŸÐžÐ”Ð ÐžÐ‘ÐÐžÐ¡Ð¢Ð˜:
                
                ðŸ“Œ Ð’Ð¡Ð¢Ð Ð•Ð§Ð Ð¡ ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐœ:
                Ð•Ð»ÐµÐ½Ð° Ð¿Ñ€Ð¾Ð²ÐµÐ»Ð° Ñ‡Ð°ÑÐ¾Ð²ÑƒÑŽ Ð²ÑÑ‚Ñ€ÐµÑ‡Ñƒ Ñ Ð”ÐµÐ½Ð¸ÑÐ¾Ð¼ Ð¸Ð· X-Tech. Ð”ÐµÐ½Ð¸Ñ Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ð» Ð¾Ð±ÐµÑÐ¿Ð¾ÐºÐ¾ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼Ð¸ ÑÑ€Ð¾ÐºÐ°Ð¼Ð¸ Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ð» Ð¿ÐµÑ€ÐµÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ñ‹ Ð·Ð°Ð´Ð°Ñ‡.
                
                ðŸ“Œ Ð—ÐÐ”ÐÐ§Ð˜ Ð”Ð›Ð¯ ÐšÐžÐœÐÐÐ”Ð«:
                ÐžÐ»ÐµÐ³ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ. ÐÐ°Ñ‚Ð°ÑˆÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸. ÐÐ½Ð´Ñ€ÐµÐ¹ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð·Ð° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ.
                
                ðŸ“Œ Ð¡Ð ÐžÐšÐ˜ Ð˜ ÐžÐ–Ð˜Ð”ÐÐÐ˜Ð¯:
                ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿ Ðº ÐºÐ¾Ð½Ñ†Ñƒ Ð¼ÐµÑÑÑ†Ð°. Ð•Ð»ÐµÐ½Ð° ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð° ÑƒÐ»Ð¾Ð¶Ð¸Ñ‚ÑŒÑÑ Ð² ÑÑ‚Ð¸ ÑÑ€Ð¾ÐºÐ¸ Ð¿Ñ€Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¿Ð»Ð°Ð½Ð°.
                """
                
                cleaned_transcript_prompt = """
                ÐžÑ‡Ð¸ÑÑ‚Ð¸ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸ÑŽ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ:
                - Ð£Ð´Ð°Ð»Ð¸ ÑÐ»Ð¾Ð²Ð°-Ð¿Ð°Ñ€Ð°Ð·Ð¸Ñ‚Ñ‹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 'ÑÐ¼', 'ÑÑ', 'Ð½Ñƒ', 'Ð²Ð¾Ñ‚', 'ÐºÐ°Ðº Ð±Ñ‹', 'Ñ‚Ð¸Ð¿Ð°')
                - Ð˜ÑÐ¿Ñ€Ð°Ð²ÑŒ Ð³Ñ€Ð°Ð¼Ð¼Ð°Ñ‚Ð¸ÐºÑƒ, Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸ÑŽ Ð¸ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾ÑÑ‚Ð¸
                - Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ð²ÑÐµ Ð·Ð½Ð°Ñ‡Ð¸Ð¼Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ
                - ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸ Ð²ÑÐµ Ð¸Ð¼ÐµÐ½Ð° Ð»ÑŽÐ´ÐµÐ¹ Ð¸ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹ Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÐ°Ðº Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»Ðµ
                - Ð Ð°Ð·Ð±ÐµÐ¹ Ð½Ð° Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð°Ð±Ð·Ð°Ñ†Ñ‹, Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ match tone-of-voice Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾
                - Ð”Ð»Ñ Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ð¸Ð»Ð¸ Ð½ÐµÑ€Ð°Ð·Ð±Ð¾Ñ€Ñ‡Ð¸Ð²Ñ‹Ñ… ÑÐ»Ð¾Ð², ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚, Ð° Ð·Ð°Ñ‚ÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñƒ Ð² ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð½Ñ‹Ñ… ÑÐºÐ¾Ð±ÐºÐ°Ñ… [ÐºÐ°Ðº Ð·Ð´ÐµÑÑŒ]
                - Ð˜ÑÐ¿Ñ€Ð°Ð²ÑŒ Ð¾Ñ‡ÐµÐ²Ð¸Ð´Ð½Ñ‹Ðµ Ð¾Ð³Ð¾Ð²Ð¾Ñ€ÐºÐ¸
                - Ð•ÑÐ»Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð» Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‰ÐµÐ³Ð¾ Ð½Ð° 100%, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÑƒÐ¶ÑÐºÐ¾Ð¹ Ñ€Ð¾Ð´ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ, 
                  Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¶ÐµÐ½ÑÐºÐ¸Ðµ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð² ÑÐºÐ¾Ð±ÐºÐ°Ñ…: Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð»(Ð°)", "ÑÐºÐ°Ð·Ð°Ð»(Ð°)"
                
                Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÑÑÐ½Ñ‹Ð¼, Ñ‡Ð¸Ñ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¼Ñ‹ÑÐ» Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ.
                """
                
                pasha_technik_prompt = """
                ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐ¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸ÑŽ Ð² Ð½ÐµÑ†ÐµÐ½Ð·ÑƒÑ€Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð² Ñ„Ð¸Ñ€Ð¼ÐµÐ½Ð½Ð¾Ð¼ ÑÑ‚Ð¸Ð»Ðµ ÐŸÐ°ÑˆÐ¸ Ð¢ÐµÑ…Ð½Ð¸ÐºÐ° (ÐŸÐ°Ð²Ð»Ð° Ð˜Ð²Ð»ÐµÐ²Ð°).
                
                ÐžÐ§Ð•ÐÐ¬ Ð’ÐÐ–ÐÐž: 
                - Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð’Ð¡Ð• Ð¸Ð¼ÐµÐ½Ð° Ð»ÑŽÐ´ÐµÐ¹ Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¹, ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚Ñ‹Ðµ Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
                - Ð’ÐºÐ»ÑŽÑ‡Ð°Ð¹ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ (ÐœÐ¸ÑˆÐ°, Ð¡Ð°ÑˆÐ°, ÐšÐ°Ñ‚Ñ Ð¸ Ñ‚.Ð´.)
                - ÐÐ• Ð·Ð°Ð¼ÐµÐ½ÑÐ¹ Ð¸Ð¼ÐµÐ½Ð° Ð½Ð° Ð¾Ð±Ð¾Ð±Ñ‰ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ðµ Ð¸Ð¼ÐµÐ½Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð² Ñ‚Ñ€Ð°Ð½ÑÐºÑ€Ð¸Ð¿Ñ†Ð¸Ð¸
                
                Ð’ÐÐ–ÐÐž:
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð½ÐµÑ†ÐµÐ½Ð·ÑƒÑ€Ð½ÑƒÑŽ, Ð³Ñ€ÑƒÐ±ÑƒÑŽ, Ð¿Ð¾ÑˆÐ»ÑƒÑŽ Ð¸ Ð¶Ð°Ñ€Ð³Ð¾Ð½Ð½ÑƒÑŽ Ð»ÐµÐºÑÐ¸ÐºÑƒ (Ð¼Ð°Ñ‚, Ð¶Ð°Ñ€Ð³Ð¾Ð½, Ð¼ÐµÐ¶Ð´Ð¾Ð¼ÐµÑ‚Ð¸Ñ, ÑÐ»Ð¾Ð²Ð°-Ð¿Ð°Ñ€Ð°Ð·Ð¸Ñ‚Ñ‹)
                - Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ñ„Ð¸Ñ€Ð¼ÐµÐ½Ð½Ñ‹Ðµ ÑÐ»Ð¾Ð²ÐµÑ‡ÐºÐ¸: "ÐºÑÐ°Ð½Ð°ÐºÑ", "Ñ‡Ñ‘", "Ð½Ð° ÑÐ¿Ð¸Ð´Ð°Ñ…", ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÐºÐ¾Ð² Ð¸ ÑˆÐ¸ÑˆÐµÐº
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¾Ñ‡ÐµÐ½ÑŒ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¸ Ñ‚Ñ€Ð¸ Ñ‚Ð¾Ñ‡ÐºÐ¸ ÐºÐ¾Ðµ-Ð³Ð´Ðµ, Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Ñ€ÐµÑˆÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ 
                - Ð’ÐºÐ»ÑŽÑ‡Ð¸ ÐµÑÐ»Ð¸ Ðº Ð¼ÐµÑÑ‚Ñƒ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ ÑÐµÐºÑÐ°, Ð²ÐµÑ‡ÐµÑ€Ð¸Ð½Ð¾Ðº, Ð¼ÐµÐ½Ñ‚Ð¾Ð² 
                
                Ð’ÐÐ–ÐÐž Ð´Ð»Ñ Telegram:
                - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð´ÐµÐ»Ð°
                - ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð·Ð½Ð°ÐºÐ¸ # Ð´Ð»Ñ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ¾Ð²
                
                ÐŸÑ€Ð¸Ð¼ÐµÑ€:
                
                ðŸ’Š ÐŸÐ ÐžÐ¡Ð›Ð£Ð¨ÐÐ› Ð¥Ð£Ð™ÐÐ®, Ð­Ð¢Ðž ÐœÐžÐ¯ Ð ÐÐ¡Ð¨Ð˜Ð¤Ð ÐžÐ’ÐšÐ ÐÐŸÐ¢Ð:
                ÐÑƒ... ÑÐ»Ñ‹ÑˆÑŒ, Ð±Ð»Ñ... ÐºÐ¾Ñ€Ð¾Ñ‡Ðµ. Ð§Ñ‘ ÑÑ‚Ð¾ Ð·Ð° Ñ…ÑƒÐ¹Ð½Ñ... ÐœÐ¸ÑˆÐ°, Ñ‚Ñ‹, Ð½Ð°Ñ…ÑƒÐ¹, Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð½Ð¾Ñ‡ÑŒÑŽ Ð¸Ð»Ð¸ ÐºÐ°Ðº? Ð¡Ñ‚Ð°Ñ‚ÑƒÑ, Ñ‚Ð¸Ð¿Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ð´Ð°? Ð¡Ñ€Ð¾ÐºÐ¸... Ð±Ð»ÑÐ´ÑŒ... Ð³Ð¾Ñ€ÑÑ‚! ÐŸÐ¸Ð·Ð´ÐµÑ†... Ð£ Ð¼ÐµÐ½Ñ, Ð½Ð°Ñ…ÑƒÐ¹... Ð¾Ñ‚ ÑÐ¾Ð»Ð¸ Ð±Ð°ÑˆÐºÐ° ÐµÐ´ÐµÑ‚... Ð° Ñ‚Ñ‹ Ð¼Ð½Ðµ Ð¿Ñ€Ð¾ Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ñ‹... Ñ‘Ð¿Ñ‚Ð°! Ð¥ÑƒÐ»Ð¸ Ð¿Ð°Ñ€Ð¸Ñ‚ÑŒÑÑ-Ñ‚Ð¾... Ð°?

                ðŸ”¥ Ð¡Ð£Ð¢Ð¬ Ð‘Ð›Ð¯Ð”Ð¡ÐšÐžÐ“Ðž Ð’ÐžÐŸÐ ÐžÐ¡Ð:
                - ÐºÐ¾Ñ€Ð¾Ñ‡Ðµ... ÐÐ½Ð´Ñ€ÐµÐ¹ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ ÐœÐ¸ÑˆÑƒ... Ð½Ñƒ... Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð»Ð¸ Ð¾Ð½ Ð½Ð¾Ñ‡ÑŒÑŽ
                - ÐÐ½Ð´Ñ€ÐµÐ¹ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ÑÑŒ Ð¿Ð¾ Ð·Ð²Ð¾Ð½ÐºÑƒ Ð² 10:30... Ñ‡Ñ‚Ð¾Ð±Ñ‹, Ð±Ð»Ñ, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ
                - ÐœÐ¸ÑˆÐ° Ð´Ð¾Ð»Ð¶ÐµÐ½ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ... Ð½Ð°Ñ…ÑƒÐ¹... Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¸Ð»Ð¸ Ñ‡Ñ‘
                
                âš¡ Ð—ÐÐŸÐžÐœÐÐ˜:
                Ð—Ð°Ð¿Ð¾Ð¼Ð½Ð¸... Ð±Ð»Ñ... Ð¿Ð°Ñ†Ð°Ð½... Ð¾Ð½ Ñ…ÑƒÐ¹ ÐºÐ»Ð°Ð´Ñ‘Ñ‚ Ð½Ð° ÑÑ‚Ð¾ Ð²ÑÑ‘... Ð½Ð° Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ñ‹ Ñ‚Ð²Ð¾Ð¸... ÐŸÐ¾Ñ…ÑƒÑŽ Ð²Ð°Ñ‰Ðµ! Ð’ÑŠÐµÐ±Ð°Ð» ÑÐ¾Ð»Ð¸... Ñ‚Ð°Ð¼... Ð½Ñƒ... Ð¿Ð»Ð°Ð½ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ð»... Ñ…ÑƒÑÐº-Ñ…ÑƒÑÐº... Ð¸ ÑÐ´ÐµÐ»Ð°Ð»! Ð’ÑÑ‘... Ð±Ð»ÑÐ´ÑŒ... Ñ‡Ñ‘Ñ‚ÐºÐ¾! ÐœÑƒÑÐ¾Ñ€Ð°... Ð½Ñƒ... Ð¾Ð½Ð¸ ÑÐ¾ÑÑƒÑ‚, ÐºÐ¾Ñ€Ð¾Ñ‡Ðµ. Ð Ð¢ÐµÑ…Ð½Ð¸Ðº... ÐŸÐ°ÑˆÐ° Ð¢ÐµÑ…Ð½Ð¸Ðº... Ð¾Ð½, ÑÑƒÐºÐ°... Ð½Ðµ Ð¿Ñ€Ð¾Ñ‘Ð±Ñ‹Ð²Ð°ÐµÑ‚. ÐÐ¸ÐºÐ¾Ð³Ð´Ð°... Ñ‘Ð¿Ñ‚Ð°.
                """

                # --- API Calls --- 
                # We always need the transcript first
                logger.debug("Requesting transcription from Gemini...")
                transcript_response = await model.generate_content_async([transcription_prompt, audio_file])
                raw_transcript = transcript_response.text
                logger.info("Transcription received.")
                logger.debug(f"Raw Transcript: {raw_transcript[:100]}...")

                summary_text = None
                transcript_text = None

                if mode == "transcript":
                    logger.debug("Requesting cleaned transcript...")
                    cleaned_response = await model.generate_content_async([cleaned_transcript_prompt, raw_transcript])
                    transcript_text = cleaned_response.text
                    logger.info("Cleaned transcript generated.")
                else:
                    # For other modes, generate the summary based on the raw transcript
                    prompt_map = {
                        "brief": brief_summary_prompt,
                        "detailed": detailed_summary_prompt,
                        "bullet": bullet_points_prompt,
                        "combined": combined_summary_prompt,
                        "pasha": pasha_technik_prompt,
                    }
                    summary_prompt = prompt_map.get(mode)
                    if not summary_prompt:
                         logger.error(f"Internal error: No prompt found for mode {mode}")
                         return None, None

                    logger.debug(f"Requesting {mode} summary...")
                    summary_response = await model.generate_content_async([summary_prompt, raw_transcript])
                    summary_text = summary_response.text
                    transcript_text = raw_transcript
                    logger.info(f"{mode.capitalize()} summary generated.")

                # --- Cleanup ---
                # Delete the uploaded file from Gemini (important for managing storage/costs)
                try:
                    logger.debug(f"Deleting Gemini file: {audio_file.name}")
                    genai.delete_file(audio_file.name)
                    logger.info(f"Successfully deleted Gemini file: {audio_file.name}")
                except Exception as e:
                    logger.warning(f"Could not delete Gemini file {audio_file.name}: {e}")

                # Success - return the result
                return summary_text, transcript_text
                
            except Exception as e:
                retry_count += 1
                if retry_count > MAX_RETRIES:
                    logger.error(f"Max retries ({MAX_RETRIES}) exceeded for Gemini API call. Final error: {str(e)}")
                    raise  # Re-raise to be caught by the outer try-except
                
                # Log retry attempt
                logger.warning(f"Gemini API call failed (attempt {retry_count}/{MAX_RETRIES}): {str(e)}. Retrying...")
                
                # Exponential backoff with jitter
                wait_time = (2 ** retry_count) + random.uniform(0, 1)
                logger.info(f"Waiting {wait_time:.2f} seconds before retry...")
                time.sleep(wait_time)
                
                # If we had an uploaded file that might be causing issues, try to delete it
                if audio_file is not None:
                    try:
                        genai.delete_file(audio_file.name)
                        logger.info(f"Deleted potentially problematic file {audio_file.name} before retry")
                    except Exception:
                        pass  # Ignore deletion errors
                    audio_file = None  # Reset for re-upload
        
        # Should never reach here due to the raise in the loop
        return None, None

    except Exception as e:
        logger.error(f"Error processing audio with Gemini: {e}", exc_info=True)
        # Attempt to clean up uploaded file if it exists
        if audio_file is not None:
             try:
                 genai.delete_file(audio_file.name)
                 logger.info(f"Cleaned up Gemini file {audio_file.name} after error.")
             except Exception as delete_e:
                 logger.warning(f"Could not delete Gemini file {audio_file.name} during error cleanup: {delete_e}")
        return None, None 
